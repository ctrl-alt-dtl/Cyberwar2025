/*******************************************************************************
 * The main game logic controller that manages the current game state
 ******************************************************************************/
var _ = require("underscore");
var Util = require("./util.js");
var ActionType = require("../../shared/actionType.js").ActionType;
var AdjudicationMath = require("../../shared/adjudicationMath.js").AdjudicationMath;

//------------------------------------------------------------------------------
this.performOrders = function(prevTurn, newTurn) {
  _.each(prevTurn.players, function(player) {
    _.each(player.orders, function(order) {
      if (order.action == ActionType.EXPLOIT) {
        var newTurnPlayer = Util.Shared.List.findPlayerByName(newTurn.players, player.name);
        var attackerNode = Util.Shared.List.getServerNode(newTurn.serverNodes, order.params.source.color, order.params.source.index);
        var defenderNode = Util.Shared.List.getServerNode(newTurn.serverNodes, order.node.color, order.node.index);
        var success = performExploit(newTurnPlayer, attackerNode, defenderNode);

        // Add a report of this action to the acting player
        var newTurnPlayer = Util.Shared.List.findPlayerByName(newTurn.players, player.name);
        var targetPlayer = Util.Shared.List.findPlayerByColor(newTurn.players, Util.Shared.List.getServerNode(prevTurn.serverNodes, order.node.color, order.node.index).ownerColor);
        var previouslyScannedNode = Util.Shared.List.isLocationInNodeList(order.node, player.scannedNodes);
        var reportParams = {
          // The node the exploit attack came from
          attackerNode: order.params.source,
          // If there was a previous owner of this node, add that to the report
          attackedPlayer: targetPlayer ? targetPlayer.name : undefined,
          // Add the attack's strength to the report
          attackStrength: attackerNode.strength,
          // Add the defense strength since the attacked player would know that
          defenderStrength: previouslyScannedNode ? defenderNode.strength : undefined,
          // Report whether the exploit was a success or not
          success: success,
        };
        Util.addReport(newTurnPlayer, ActionType.EXPLOIT, order.node, reportParams);
      }
    });
  });
}

//------------------------------------------------------------------------------
var performExploit = function(player, attackerNode, defenderNode) {
  var success = false;
  console.log('Exploit attack: Defender = ' + defenderNode.strength + ' Attacker = ' + attackerNode.strength);
  if (AdjudicationMath.captureOddsOneVsOne(defenderNode.strength, attackerNode.strength)) {
    player.exploitLinks.push({ nodeA: attackerNode.location, nodeB: defenderNode.location });
    success = true;
  }
  return success;
}
