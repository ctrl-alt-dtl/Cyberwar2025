angular.module('CyberWar')
.directive('exploitLink', ['GameUtil', function(GameUtil) {
  function link($scope, element, attrs) {
    var line;

    // ----------------------------------------------------------------------------
    $scope.$on('$destroy', function() {
      line.remove();
    });

    // ----------------------------------------------------------------------------
    var createKonvaObjects = function(nodeA, nodeB) {
      // Get the positions of our endpoints
      var nodeAPosition = GameUtil.getHexPosition(nodeA.color, nodeA.index);
      var nodeBPosition = GameUtil.getHexPosition(nodeB.color, nodeB.index);

      // Special case positioning for links from a base
      if (nodeA.index == 0 && nodeB.index == 1) {
        nodeAPosition = { x: nodeAPosition.x1, y: nodeAPosition.y1 };
      }
      else if (nodeA.index == 0 && nodeB.index == 2) {
        nodeAPosition = { x: nodeAPosition.x2, y: nodeAPosition.y2 };
      }
      if (nodeA.index == 2 && nodeB.index == 0) {
        nodeBPosition = { x: nodeBPosition.x2, y: nodeBPosition.y2 };
      }
      else if (nodeA.index == 1 && nodeB.index == 0) {
        nodeBPosition = { x: nodeBPosition.x1, y: nodeBPosition.y1 };
      }

      // Create the Konva line
      line = new Konva.Line({
        points: [
          nodeAPosition.x,
          nodeAPosition.y,
          nodeBPosition.x,
          nodeBPosition.y
        ],
        stroke: 'black',
        strokeWidth: exploitLinksStroke,
        lineCap: 'square',
        lineJoin: 'square',
        dash: [
          exploitLineDashWidth,
          exploitLineDashGap
        ],
        visible: lineVisible,
        id: nodeA.color + nodeA.index + ' to ' + nodeB.color + nodeB.index + ' Exploit Link',
        listening: false,
      });
      linksGroup.add(line);
    }
    createKonvaObjects($scope.nodeA, $scope.nodeB);
  }
  return {
    link: link,
    restrict: 'E',
    scope: {
      callbackFn: '&',
      nodeA: '=',
      nodeB: '='
    },
  }
}]);
